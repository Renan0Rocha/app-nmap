{% extends 'scanner/base_simple.html' %}

{% block title %}Port Scanner{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-2">
                <i class="fas fa-search me-3 text-primary"></i>
                Port Scanner
            </h1>
            <p class="lead text-muted">
                Ferramenta de varredura de portas TCP/UDP
            </p>
        </div>
    </div>

    <!-- Main Scan Form -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-radar me-2"></i>
                        Configuração de Varredura
                    </h5>
                </div>
                <div class="card-body">
                    <form id="scanForm">
                        {% csrf_token %}
                        
                        <!-- Target -->
                        <div class="mb-3">
                            <label for="target" class="form-label">
                                <strong>Target (Alvos para Escaneamento)</strong>
                            </label>
                            <input type="text" class="form-control" id="target" name="target" 
                                   placeholder="192.168.1.1 ou 192.168.1.0/24 ou múltiplos..." required>
                            <div class="form-text">
                                <strong>Formatos suportados:</strong><br>
                                • <strong>IP único:</strong> <code>192.168.1.1</code><br>
                                • <strong>Múltiplos IPs:</strong> <code>192.168.1.1,192.168.1.10,192.168.1.20</code><br>
                                • <strong>Range CIDR:</strong> <code>192.168.1.0/24</code> (todos IPs da rede)<br>
                                • <strong>Hostname:</strong> <code>google.com</code><br>
                                • <strong>Misto:</strong> <code>192.168.1.1,google.com,10.0.0.0/28</code>
                            </div>
                            
                            <!-- Botões de Exemplo Rápido -->
                            <div class="mt-2">
                                <small class="text-muted d-block mb-1"><strong>Exemplos rápidos:</strong></small>
                                <div class="btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-1" 
                                            onclick="document.getElementById('target').value='127.0.0.1'">
                                        <i class="fas fa-home"></i> Localhost
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-1" 
                                            onclick="document.getElementById('target').value='192.168.1.0/24'">
                                        <i class="fas fa-network-wired"></i> Rede Local
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-1" 
                                            onclick="document.getElementById('target').value='192.168.1.1,192.168.1.10,192.168.1.20'">
                                        <i class="fas fa-list"></i> Múltiplos IPs
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                                            onclick="document.getElementById('target').value='google.com,facebook.com'">
                                        <i class="fas fa-globe"></i> Websites
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Portas -->
                        <div class="mb-3">
                            <label for="ports" class="form-label">
                                <strong>Portas</strong>
                            </label>
                            <select class="form-select" id="ports" name="ports">
                                <option value="common">Portas Comuns (21,22,23,25,53,80,110,443,993,995)</option>
                                <option value="80,443">Web (80,443)</option>
                                <option value="22,23,80,443">Básicas (22,23,80,443)</option>
                                <option value="1-1000">Range 1-1000</option>
                                <option value="custom">Personalizado...</option>
                            </select>
                        </div>

                        <!-- Portas Customizadas -->
                        <div class="mb-3 d-none" id="customPortsDiv">
                            <label for="customPorts" class="form-label">Portas Personalizadas</label>
                            <input type="text" class="form-control" id="customPorts" name="customPorts" 
                                   placeholder="80,443,8080 ou 1-100 ou 80,90-95,443">
                            <div class="form-text">
                                Formatos: 80,443 ou 1-100 ou combinados
                            </div>
                        </div>

                        <!-- Protocolo -->
                        <div class="mb-3">
                            <label class="form-label">
                                <strong>Protocolo</strong>
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="tcp" name="protocols" value="tcp" checked>
                                        <label class="form-check-label" for="tcp">
                                            TCP (Transmission Control Protocol)
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="udp" name="protocols" value="udp">
                                        <label class="form-check-label" for="udp">
                                            UDP (User Datagram Protocol)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações Avançadas -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="timeout" class="form-label">
                                    <strong>Timeout (segundos)</strong>
                                </label>
                                <select class="form-select" id="timeout" name="timeout">
                                    <option value="1">1s (Rede Local - Rápido)</option>
                                    <option value="3" selected>3s (Padrão)</option>
                                    <option value="5">5s (Rede Externa)</option>
                                    <option value="10">10s (Conexão Lenta)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="threads" class="form-label">
                                    <strong>Threads</strong>
                                </label>
                                <select class="form-select" id="threads" name="threads">
                                    <option value="10">10 (Conservador)</option>
                                    <option value="50" selected>50 (Padrão)</option>
                                    <option value="100">100 (Rápido)</option>
                                    <option value="200">200 (Agressivo)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Botão de Scan -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-play me-2"></i>
                                Iniciar Varredura
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Área de Resultados -->
    <div class="row mt-4" id="resultsArea" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Resultados da Varredura
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scanResults">
                        <!-- Resultados serão inseridos aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-cog fa-spin me-2"></i>
                        Varredura em Progresso
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-radar fa-3x text-primary mb-3"></i>
                        <p class="mb-3">Executando varredura de portas...</p>
                    </div>
                    
                    <div class="progress mb-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="progressBar" style="width: 0%">0%</div>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted d-block">Verificadas</small>
                            <strong id="scannedCount">0</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Total</small>
                            <strong id="totalCount">0</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted d-block">Abertas</small>
                            <strong id="openCount" class="text-success">0</strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="stopScanBtn">
                        <i class="fas fa-stop me-2"></i>
                        Parar Varredura
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Aviso Legal -->
<div class="container-fluid mt-5">
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Aviso Legal:</strong> Use esta ferramenta apenas em redes próprias ou com autorização explícita. 
        O uso não autorizado pode violar leis locais e termos de serviço.
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const scanForm = document.getElementById('scanForm');
    const portsSelect = document.getElementById('ports');
    const customPortsDiv = document.getElementById('customPortsDiv');
    
    // Mostrar/esconder campos de portas customizadas
    portsSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
            customPortsDiv.classList.remove('d-none');
            document.getElementById('customPorts').required = true;
        } else {
            customPortsDiv.classList.add('d-none');
            document.getElementById('customPorts').required = false;
        }
    });

    // Submit do formulário
    scanForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const target = formData.get('target');
        let ports = formData.get('ports');
        
        // Se for portas customizadas, pegar do campo personalizado
        if (ports === 'custom') {
            ports = formData.get('customPorts');
            if (!ports) {
                alert('Por favor, especifique as portas personalizadas.');
                return;
            }
        }
        
        // Verificar protocolos selecionados
        const protocols = formData.getAll('protocols');
        if (protocols.length === 0) {
            alert('Selecione pelo menos um protocolo (TCP ou UDP).');
            return;
        }
        
        // Dados do scan
        const scanData = {
            target: target,
            ports: ports,
            protocols: protocols,
            timeout: parseInt(formData.get('timeout')),
            threads: parseInt(formData.get('threads'))
        };
        
        console.log('Iniciando scan com dados:', scanData);
        
        // Iniciar varredura
        startScan(scanData);
    });
});

function startScan(scanData) {
    console.log('startScan called with:', scanData);
    
    // Desabilitar botão de submit
    const submitButton = document.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Escaneando...';
    
    // Mostrar modal de progresso
    const progressModalElement = document.getElementById('progressModal');
    const progressModal = new bootstrap.Modal(progressModalElement);
    progressModal.show();
    
    // Reset progress
    updateProgress(0, 100, 0, 0);
    
    // Obter token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Simular progresso visual enquanto executa
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 5;
        updateProgress(Math.floor(progress), 100, 0, Math.min(progress, 90));
        
        if (progress >= 90) {
            clearInterval(interval);
        }
    }, 200);
    
    // Fazer requisição para API
    console.log('Enviando requisição para API com dados:', scanData);
    
    fetch('/api/simple-scan/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(scanData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('API Response received:', data);
        
        // Parar o intervalo de progresso
        clearInterval(interval);
        
        // Forçar fechamento do modal IMEDIATAMENTE
        console.log('Fechando modal forçadamente...');
        const progressModalElement = document.getElementById('progressModal');
        
        // Método 1: Tentar usar Bootstrap
        const modalInstance = bootstrap.Modal.getInstance(progressModalElement);
        if (modalInstance) {
            modalInstance.hide();
        }
        
        // Método 2: Forçar fechamento direto (sempre executar)
        setTimeout(() => {
            progressModalElement.style.display = 'none';
            progressModalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            // Remover backdrop
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            console.log('Modal fechado forçadamente');
        }, 100);
        
        console.log('Processando resposta...');
        
        if (data.success) {
            try {
                showRealResults(scanData, data.results, data.open_ports);
            } catch (error) {
                console.error('Erro ao mostrar resultados:', error);
                alert('Erro ao processar resultados: ' + error.message);
            }
        } else {
            alert('Erro no scan: ' + data.error);
            if (data.cli_command) {
                showCliInstructions(scanData, data.cli_command);
            }
        }
        
        // Reativar botão de scan
        const submitButton = document.querySelector('button[type="submit"]');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-play me-2"></i>Iniciar Varredura';
    })
    .catch(error => {
        console.error('Erro de conexão:', error);
        
        // Parar o intervalo e forçar fechamento do modal
        clearInterval(interval);
        
        // Forçar fechamento completo
        const progressModalElement = document.getElementById('progressModal');
        const modalInstance = bootstrap.Modal.getInstance(progressModalElement);
        if (modalInstance) {
            modalInstance.hide();
        }
        
        setTimeout(() => {
            progressModalElement.style.display = 'none';
            progressModalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
        }, 100);
        
        // Gerar comando CLI como fallback
        const protocols = scanData.protocols || ['tcp'];
        let cliCommand = 'python port_scanner.py {target} --ports {ports}';
        if (protocols.includes('tcp') && protocols.includes('udp')) {
            cliCommand += ' --protocol both';
        } else if (protocols.includes('udp')) {
            cliCommand += ' --protocol udp';
        }
        
        showCliInstructions(scanData, cliCommand);
        
        // Reativar botão de scan
        const submitButton = document.querySelector('button[type="submit"]');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-play me-2"></i>Iniciar Varredura';
    });
    
    // Parar scan (cancelar requisição se possível)
    document.getElementById('stopScanBtn').onclick = function() {
        console.log('Parando scan...');
        clearInterval(interval);
        
        // Forçar fechamento completo do modal
        const progressModalElement = document.getElementById('progressModal');
        const modalInstance = bootstrap.Modal.getInstance(progressModalElement);
        if (modalInstance) {
            modalInstance.hide();
        }
        
        // Forçar fechamento imediato
        progressModalElement.style.display = 'none';
        progressModalElement.classList.remove('show');
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Reativar botão
        const submitButton = document.querySelector('button[type="submit"]');
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="fas fa-play me-2"></i>Iniciar Varredura';
    };
}

function updateProgress(scanned, total, open, percentage) {
    document.getElementById('scannedCount').textContent = scanned;
    document.getElementById('totalCount').textContent = total;
    document.getElementById('openCount').textContent = open;
    
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percentage + '%';
    progressBar.textContent = Math.round(percentage) + '%';
}

function showRealResults(scanData, results, openPorts) {
    console.log('showRealResults called with:', { scanData, results, openPorts });
    
    const resultsArea = document.getElementById('resultsArea');
    const scanResults = document.getElementById('scanResults');
    
    if (!resultsArea || !scanResults) {
        console.error('Elements not found:', { resultsArea, scanResults });
        return;
    }
    
    // Agrupar resultados por host
    const hosts = {};
    try {
        results.forEach(result => {
            console.log('Processing result:', result);
            if (!hosts[result.host]) {
                hosts[result.host] = {
                    hostname: result.hostname || result.host,
                    ports: []
                };
            }
            hosts[result.host].ports.push(result);
        });
    } catch (error) {
        console.error('Error processing results:', error);
        return;
    }
    
    let hostCardsHtml = '';
    Object.keys(hosts).forEach(hostIp => {
        const host = hosts[hostIp];
        const openPortsForHost = host.ports.filter(p => p.status === 'open');
        
        hostCardsHtml += `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-server me-2"></i>
                        ${hostIp} ${host.hostname && host.hostname !== hostIp ? '(' + host.hostname + ')' : ''}
                        <span class="badge bg-success ms-2">${openPortsForHost.length} porta(s) aberta(s)</span>
                    </h6>
                </div>
                <div class="card-body">
                    ${host.ports.map(port => `
                        <div class="row mb-2 ${port.status === 'open' ? 'text-success' : 'text-muted'}">
                            <div class="col-md-3">
                                <strong>${port.port}/${port.protocol.toUpperCase()}</strong>
                            </div>
                            <div class="col-md-2">
                                <span class="badge ${port.status === 'open' ? 'bg-success' : 'bg-secondary'}">
                                    ${port.status.toUpperCase()}
                                </span>
                            </div>
                            <div class="col-md-3">
                                ${port.service || '-'}
                            </div>
                            <div class="col-md-4">
                                <small>${port.version || port.banner || '-'}</small>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    const resultHtml = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle me-2"></i>Varredura Concluída</h6>
            <p class="mb-0">Target: <strong>${scanData.target}</strong> | 
               Portas: <strong>${scanData.ports}</strong> | 
               Protocolos: <strong>${scanData.protocols.join(', ').toUpperCase()}</strong></p>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h3>${openPorts}</h3>
                        <p class="mb-0">Portas Abertas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h3>${Object.keys(hosts).length}</h3>
                        <p class="mb-0">Hosts</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h3>${results.length}</h3>
                        <p class="mb-0">Total Portas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-secondary">
                    <div class="card-body text-center">
                        <h3>${results.filter(r => r.status !== 'open').length}</h3>
                        <p class="mb-0">Fechadas/Filtradas</p>
                    </div>
                </div>
            </div>
        </div>
        
        <h6>Detalhes por Host:</h6>
        ${hostCardsHtml}
    `;
    
    scanResults.innerHTML = resultHtml;
    resultsArea.style.display = 'block';
    resultsArea.scrollIntoView({ behavior: 'smooth' });
}

function showCliInstructions(scanData, cliCommand) {
    const resultsArea = document.getElementById('resultsArea');
    const scanResults = document.getElementById('scanResults');
    
    const command = cliCommand
        .replace('{target}', scanData.target)
        .replace('{ports}', scanData.ports);
    
    const instructionsHtml = `
        <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Backend não disponível</h6>
            <p>Execute o scan manualmente via linha de comando:</p>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-terminal me-2"></i>
                    Comando CLI
                </h6>
            </div>
            <div class="card-body">
                <div class="bg-dark text-light p-3 rounded">
                    <code>${command}</code>
                </div>
                <button class="btn btn-outline-primary mt-2" onclick="copyToClipboard('${command}')">
                    <i class="fas fa-copy me-2"></i>
                    Copiar Comando
                </button>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <h6>Passos para executar:</h6>
            <ol class="mb-0">
                <li>Abra um terminal/prompt de comando</li>
                <li>Navegue até o diretório do projeto: <code>cd "C:\\...\\app-nmap"</code></li>
                <li>Execute o comando acima</li>
                <li>Os resultados serão exibidos no terminal</li>
            </ol>
        </div>
    `;
    
    scanResults.innerHTML = instructionsHtml;
    resultsArea.style.display = 'block';
    resultsArea.scrollIntoView({ behavior: 'smooth' });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Comando copiado para a área de transferência!');
    });
}

// Função de emergência para fechar modal travado
window.forceCloseModal = function() {
    console.log('Fechando modal forçadamente...');
    const progressModalElement = document.getElementById('progressModal');
    
    // Tentar Bootstrap primeiro
    const modalInstance = bootstrap.Modal.getInstance(progressModalElement);
    if (modalInstance) {
        modalInstance.dispose();
    }
    
    // Forçar fechamento completo
    progressModalElement.style.display = 'none';
    progressModalElement.classList.remove('show', 'modal');
    progressModalElement.setAttribute('aria-hidden', 'true');
    progressModalElement.removeAttribute('aria-modal');
    
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    // Remover todos os backdrops
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    
    console.log('Modal fechado com sucesso!');
};
</script>
{% endblock %}
