{% extends 'scanner/base.html' %}

{% block title %}Port Scanner - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <!-- Quick Scan Card -->
    <div class="col-lg-6 mb-4">
        <div class="card scan-card h-100">
            <div class="card-header bg-gradient-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Varredura Rápida
                </h5>
            </div>
            <div class="card-body">
                <form id="quickScanForm">
                    <div class="mb-3">
                        <label for="quickTarget" class="form-label">Target (IP/CIDR/Hostname)</label>
                        <input type="text" class="form-control" id="quickTarget" 
                               placeholder="192.168.1.0/24 ou example.com" required>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Exemplos: 192.168.1.1, 192.168.1.0/24, google.com
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-play me-2"></i>
                        Iniciar Varredura Rápida
                    </button>
                </form>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Varredura rápida usa portas comuns (TCP)
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Scan Card -->
    <div class="col-lg-6 mb-4">
        <div class="card scan-card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Varredura Avançada
                </h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success w-100 mb-3" onclick="showNewScanModal()">
                    <i class="fas fa-sliders-h me-2"></i>
                    Configurar Varredura Personalizada
                </button>
                
                <div class="row text-center">
                    <div class="col-4">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="quickScanPreset('top100')">
                            Top 100
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="quickScanPreset('top1000')">
                            Top 1000
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-success btn-sm w-100" onclick="quickScanPreset('udp')">
                            UDP Scan
                        </button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-wrench me-1"></i>
                        Configure portas, protocolos e timing
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-tasks fa-2x text-primary mb-2"></i>
                <h4 class="mb-0" id="totalJobs">-</h4>
                <small class="text-muted">Total de Jobs</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-play-circle fa-2x text-info mb-2"></i>
                <h4 class="mb-0" id="runningJobs">-</h4>
                <small class="text-muted">Em Execução</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h4 class="mb-0" id="completedJobs">-</h4>
                <small class="text-muted">Concluídos</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-door-open fa-2x text-warning mb-2"></i>
                <h4 class="mb-0" id="openPorts">-</h4>
                <small class="text-muted">Portas Abertas</small>
            </div>
        </div>
    </div>
</div>

<!-- Active Scans -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Varreduras Recentes
        </h5>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshJobs()">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
    <div class="card-body">
        <div id="jobsList">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando varreduras...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/scanner.js' %}"></script>
<script>
// Carrega dados iniciais
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadRecentJobs();
    
    // Atualiza a cada 5 segundos
    setInterval(function() {
        loadStatistics();
        loadRecentJobs();
    }, 5000);
});

// Varredura rápida
document.getElementById('quickScanForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const target = document.getElementById('quickTarget').value.trim();
    if (!target) {
        alert('Por favor, insira um target válido');
        return;
    }
    
    quickScan(target);
});

function quickScan(target) {
    const btn = document.querySelector('#quickScanForm button[type="submit"]');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Iniciando...';
    btn.disabled = true;
    
    fetch('/api/quick-scan/', {
        method: 'POST',
        headers: DEFAULT_HEADERS,
        body: JSON.stringify({ target: target })
    })
    .then(response => response.json())
    .then(data => {
        if (data.job_id) {
            showAlert('Varredura iniciada com sucesso!', 'success');
            document.getElementById('quickTarget').value = '';
            loadRecentJobs();
        } else {
            showAlert('Erro ao iniciar varredura: ' + (data.error || 'Erro desconhecido'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Erro de conexão: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function quickScanPreset(type) {
    const target = prompt('Digite o target (IP/CIDR/hostname):');
    if (!target) return;
    
    let config = { target: target, tcp: true };
    
    switch(type) {
        case 'top100':
            config.use_top100 = true;
            break;
        case 'top1000':
            config.use_top1000 = true;
            break;
        case 'udp':
            config.use_common_ports = true;
            config.udp = true;
            config.tcp = false;
            break;
    }
    
    startAdvancedScan(config);
}

function startAdvancedScan(config) {
    fetch('/api/scans/', {
        method: 'POST',
        headers: DEFAULT_HEADERS,
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.job_id) {
            showAlert('Varredura avançada iniciada!', 'success');
            loadRecentJobs();
        } else {
            showAlert('Erro: ' + (data.error || 'Erro desconhecido'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Erro de conexão: ' + error.message, 'danger');
    });
}

function loadStatistics() {
    fetch('/api/statistics/')
    .then(response => response.json())
    .then(data => {
        document.getElementById('totalJobs').textContent = data.total_jobs || 0;
        document.getElementById('runningJobs').textContent = data.running_jobs || 0;
        document.getElementById('completedJobs').textContent = data.completed_jobs || 0;
        document.getElementById('openPorts').textContent = data.open_ports || 0;
    })
    .catch(error => console.error('Erro ao carregar estatísticas:', error));
}

function loadRecentJobs() {
    fetch('/api/scans/?page_size=10')
    .then(response => response.json())
    .then(data => {
        const jobsList = document.getElementById('jobsList');
        
        if (data.results && data.results.length > 0) {
            jobsList.innerHTML = data.results.map(job => createJobCard(job)).join('');
        } else {
            jobsList.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>Nenhuma varredura encontrada</p>
                    <small>Inicie uma nova varredura para ver os resultados aqui</small>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Erro ao carregar jobs:', error);
        document.getElementById('jobsList').innerHTML = `
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Erro ao carregar varreduras
            </div>
        `;
    });
}

function createJobCard(job) {
    const statusClass = getStatusClass(job.status);
    const statusIcon = getStatusIcon(job.status);
    const createdAt = new Date(job.created_at).toLocaleString('pt-BR');
    
    return `
        <div class="card mb-2">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="${statusIcon} me-2 ${statusClass}"></i>
                            <div>
                                <strong>${job.target}</strong>
                                <br>
                                <small class="text-muted">${createdAt}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar ${statusClass}" 
                                     style="width: ${job.progress || 0}%"></div>
                            </div>
                            <small class="text-muted">${job.progress || 0}%</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="viewJobDetails('${job.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${job.status === 'running' ? 
                            `<button class="btn btn-sm btn-outline-danger" 
                                     onclick="stopJob('${job.id}')">
                                <i class="fas fa-stop"></i>
                             </button>` : ''
                        }
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getStatusClass(status) {
    const classes = {
        'pending': 'text-secondary',
        'running': 'text-info',
        'completed': 'text-success',
        'failed': 'text-danger',
        'cancelled': 'text-warning'
    };
    return classes[status] || 'text-muted';
}

function getStatusIcon(status) {
    const icons = {
        'pending': 'fas fa-clock',
        'running': 'fas fa-spinner fa-spin',
        'completed': 'fas fa-check-circle',
        'failed': 'fas fa-times-circle',
        'cancelled': 'fas fa-ban'
    };
    return icons[status] || 'fas fa-question-circle';
}

function viewJobDetails(jobId) {
    window.location.href = `/job/${jobId}/`;
}

function stopJob(jobId) {
    if (confirm('Tem certeza que deseja parar esta varredura?')) {
        fetch(`/api/scans/${jobId}/stop/`, {
            method: 'POST',
            headers: DEFAULT_HEADERS
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                showAlert('Varredura interrompida', 'info');
                loadRecentJobs();
            } else {
                showAlert('Erro ao parar varredura', 'danger');
            }
        })
        .catch(error => showAlert('Erro de conexão', 'danger'));
    }
}

function refreshJobs() {
    loadRecentJobs();
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Funções de modal (implementar depois)
function showNewScanModal() {
    alert('Modal de nova varredura - Em desenvolvimento');
}

function loadHistory() {
    alert('Histórico - Em desenvolvimento');
}

function showStatistics() {
    alert('Estatísticas detalhadas - Em desenvolvimento');
}

function showSettings() {
    alert('Configurações - Em desenvolvimento');
}

function showHelp() {
    alert('Ajuda - Em desenvolvimento');
}
</script>
{% endblock %}
